<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; The Black-Scholes Formula – Pricing and Hedging Derivative Securities</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Chapter_MertonMargrabeBlack.html" rel="next">
<link href="./Chapter_ArbitragePricing.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b53751a350365c71b6c909e95f209ed1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-219a68e4d36c545440d351964d4988f6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-2281372ddb8f8a4bf28bfb0040ef0756.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-2.35.2.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<style>
div.callout-Example.callout {
  border-left-color: #a1bced;
}
div.callout-Example.callout-style-default > .callout-header {
  background-color: rgba(161, 188, 237, 0.13);
}
div.callout-Example .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-Example.callout-style-default .callout-icon::before, div.callout-Example.callout-titled .callout-icon::before {
  font-family: 'Font Awesome 6 Free';
  content: '\f185';
  background-image: none;
}
div.callout-Rule.callout {
  border-left-color: #12801f;
}
div.callout-Rule.callout-style-default > .callout-header {
  background-color: rgba(18, 128, 31, 0.13);
}
div.callout-Rule .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-Rule.callout-style-default .callout-icon::before, div.callout-Rule.callout-titled .callout-icon::before {
  font-family: 'Font Awesome 6 Free';
  content: '\f164';
  background-image: none;
}
div.callout-Extra.callout {
  border-left-color: #a1bced;
}
div.callout-Extra.callout-style-default > .callout-header {
  background-color: rgba(161, 188, 237, 0.13);
}
div.callout-Extra .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-Extra.callout-style-default .callout-icon::before, div.callout-Extra.callout-titled .callout-icon::before {
  font-family: 'Font Awesome 6 Free';
  content: '\f48b';
  background-image: none;
}
div.callout-Principle.callout {
  border-left-color: #eb4034;
}
div.callout-Principle.callout-style-default > .callout-header {
  background-color: rgba(235, 64, 52, 0.13);
}
div.callout-Principle .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-Principle.callout-style-default .callout-icon::before, div.callout-Principle.callout-titled .callout-icon::before {
  font-family: 'Font Awesome 6 Free';
  content: '\f06a';
  background-image: none;
}
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="custom.css">
</head>

<body class="nav-sidebar floating fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter_ArbitragePricing.html">Part 3: Option Pricing</a></li><li class="breadcrumb-item"><a href="./Chapter_BlackScholes.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Black-Scholes Formula</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Pricing and Hedging Derivative Securities</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://chat.derivative-securities.org/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-chat-square-text"></i></a>
    <a href="https://github.com/math-finance-book/book-published-code.git" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 1: Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_IntroDerivatives.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Derivative Securities</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_IntroOptions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Options Markets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_IntroFutures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Futures Markets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_Trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Binomial Trees</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 2: Mathematical Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_BrownianMotion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Brownian Motion</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_Ito.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ito Processes and Ito’s Formula</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_GeometricBrownianMotion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Geometric Brownian Motion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 3: Option Pricing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_ArbitragePricing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Arbitrage Pricing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_BlackScholes.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Black-Scholes Formula</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_MertonMargrabeBlack.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Merton, Black, and Margrabe</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_Asians.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Asians, Baskets, and Spreads</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_OtherExotics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Other Exotics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 4: Numerical Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_MonteCarlo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Monte Carlo Methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_BinomialModel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Binomial and Trinomial Models</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter_ArbitragePricing.html">Part 3: Option Pricing</a></li><li class="breadcrumb-item"><a href="./Chapter_BlackScholes.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Black-Scholes Formula</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-c:blackscholes_updated" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Black-Scholes Formula</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="43583632" class="cell" data-execution_count="1">
<div class="cell-output cell-output-display">
<script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_SVG"></script>
</div>
</div>
<p>In the previous chapter, we developed a general framework for derivative pricing based on the absence of arbitrage. We saw how linear pricing leads to state prices, risk-neutral probabilities, and the fundamental pricing formula. We also introduced change of numeraire methods, which allow us to compute option values as expectations under different probability measures. In this chapter, we apply these principles to derive and analyze the celebrated Black-Scholes formula for European option pricing.</p>
<p>A fundamental insight is that standard European options can be expressed as combinations of digital options. Understanding this connection provides both theoretical insight and practical computational advantages.</p>
<p>The Black-Scholes model assumes that the underlying asset pays a constant dividend yield <span class="math inline">\(q \mathrm{d} t\)</span> (in other words the stock pays the dividend <span class="math inline">\(q S_t \mathrm{d}t\)</span>) and has an ex-dividend price <span class="math inline">\(S\)</span> satisfying</p>
<p><span class="math display">\[\frac{\mathrm{d}S}{S} = (\mu - q) \mathrm{d}t + \sigma \mathrm{d}B\]</span></p>
<p>for a Brownian motion <span class="math inline">\(B\)</span>, where <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\mu\)</span> are assumed to be constant. We also assume a constant continuously-compounded risk-free rate <span class="math inline">\(r\)</span>. In this model <span class="math inline">\(\mathrm{d}S\)</span> represents the capital gain and <span class="math inline">\(q S_t \mathrm{d}t\)</span> is the dividend portion of the return.</p>
<section id="digital-options-as-building-blocks" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="digital-options-as-building-blocks"><span class="header-section-number">9.1</span> Digital Options as Building Blocks</h2>
<p>Before deriving the Black-Scholes formula, we need to understand how standard options relate to digital options. A <strong>digital option</strong> (also called binary option) has a discontinuous payoff—it pays a fixed amount if a condition is met, zero otherwise.</p>
<section id="two-types-of-digitals" class="level4">
<h4 class="anchored" data-anchor-id="two-types-of-digitals">Two Types of Digitals</h4>
<p>Consider a call option with strike <span class="math inline">\(K\)</span> and maturity <span class="math inline">\(T\)</span>. Its payoff <span class="math inline">\((S_T - K)^+\)</span> can be decomposed as:</p>
<p><span class="math display">\[(S_T - K)^+ = \mathbf{1}_{\{S_T &gt; K\}} S_T - K \mathbf{1}_{\{S_T &gt; K\}}\]</span></p>
<p>This reveals that a call option is the difference between two digital options:</p>
<ol type="1">
<li><strong>Share digital</strong>: Pays <span class="math inline">\(S_T\)</span> when <span class="math inline">\(S_T &gt; K\)</span>, zero otherwise</li>
<li><strong>Cash digital</strong>: Pays <span class="math inline">\(K\)</span> when <span class="math inline">\(S_T &gt; K\)</span>, zero otherwise</li>
</ol>
<p>Similarly, a put option with payoff <span class="math inline">\((K - S_T)^+\)</span> can be written as:</p>
<p><span class="math display">\[(K - S_T)^+ = K \mathbf{1}_{\{S_T &lt; K\}} - \mathbf{1}_{\{S_T &lt; K\}} S_T\]</span></p>
<p>This is <span class="math inline">\(K\)</span> cash digitals minus share digitals, both paying when <span class="math inline">\(S_T &lt; K\)</span>.</p>
</section>
<section id="why-this-decomposition-matters-note-mark-hates-this-section" class="level4">
<h4 class="anchored" data-anchor-id="why-this-decomposition-matters-note-mark-hates-this-section">Why This Decomposition Matters Note: Mark Hates this section</h4>
<p>This decomposition is powerful because:</p>
<ol type="1">
<li><strong>Computational efficiency</strong>: Digital options have closed-form expressions involving only normal probabilities</li>
<li><strong>Theoretical insight</strong>: It connects discrete payoffs to continuous probability distributions</li>
<li><strong>Risk management</strong>: Greeks can be computed directly from the normal density function</li>
<li><strong>Generalization</strong>: The approach extends to exotic options and other underlying processes</li>
</ol>
</section>
</section>
<section id="girsanovs-theorem-in-the-black-scholes-model" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="girsanovs-theorem-in-the-black-scholes-model"><span class="header-section-number">9.2</span> Girsanov’s Theorem in the Black-Scholes Model</h2>
<p>To value digital options, we need to understand changes of probability measures in continuous time. When we change probability measures, a process <span class="math inline">\(B\)</span> that was a Brownian motion cannot be expected to remain a Brownian motion under the new measure. However, Girsanov’s Theorem tells us exactly how the drift changes.</p>
<p>In the Black-Scholes model, the dividend-reinvested stock price, denoted <span class="math inline">\(Y_t\)</span> follows:</p>
<p><span class="math display">\[\mathrm{d}Y_t = \mu Y_t \mathrm{d}t + \sigma Y_t \mathrm{d}B_t\]</span></p>
<p>We can rewrite this as:</p>
<p><span class="math display">\[\mathrm{d}Y_t = r Y_t \mathrm{d}t + \sigma Y_t \mathrm{d}\left(B_t + \frac{\mu - r}{\sigma}t\right)\]</span></p>
<p>Define <span class="math inline">\(\kappa = \frac{\mu - r}{\sigma}\)</span>, called the market price of risk or Sharpe ratio.</p>
<div class="callout callout-style-simple callout-Principle callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important Principle
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Girsanov’s Theorem</strong>: Define the exponential martingale:</p>
<p><span class="math display">\[Z_t = \exp\left(-\frac{1}{2}\kappa^2 t - \kappa B_t\right)\]</span></p>
<p>Since <span class="math inline">\(Z_T\)</span> is lognormal, <span class="math inline">\(\mathbb{E}[Z_T] = 1\)</span>. Under the probability measure defined by:</p>
<p><span class="math display">\[\mathbb{E}^\kappa[Y] = \mathbb{E}[Z_T X]\]</span></p>
<p>for any function <span class="math inline">\(X\)</span> of <span class="math inline">\(B_t\)</span> (<span class="math inline">\(0 \leq t \leq T\)</span>), the process <span class="math inline">\(B_t^\kappa = B_t + \kappa t\)</span> is a Brownian motion. Moreover, if <span class="math inline">\(M_t\)</span> is a martingale under the new measure, then <span class="math inline">\(Z_t M_t\)</span> is a martingale under the original measure.</p>
</div>
</div>
<p>This theorem tells us how to construct the risk-neutral measure from the original measure. Using Ito’s lemma, we can verify that <span class="math inline">\(Z_t \frac{Y_t}{R_t}\)</span> is indeed a martingale:</p>
<p><span class="math display">\[Z_t \frac{Y_t}{R_t} = S_0 \exp\left(-\frac{1}{2}(\sigma - \kappa)^2 t + (\sigma - \kappa)B_t\right)\]</span></p>
<p>Therefore this is a lognormal random variable and taking expectations gives:</p>
<p><span class="math display">\[\mathbb{E}\left[Z_t \frac{Y_t}{R_t}\right] = S_0\]</span></p>
<section id="dividend-reinvested-stock-as-numeraire" class="level4">
<h4 class="anchored" data-anchor-id="dividend-reinvested-stock-as-numeraire">Dividend Reinvested Stock as Numeraire</h4>
<p>When using the stock as numeraire, we need the process <span class="math inline">\(\frac{R_t}{Y_t}\)</span> to be a martingale. Following similar analysis with Girsanov’s Theorem, we find that under the stock numeraire measure:</p>
<p><span class="math display">\[\mathrm{d}Y_t = (r + \sigma^2) Y_t \mathrm{d}t + \sigma V_t \mathrm{d}B_t^Y\]</span></p>
<p>where <span class="math inline">\(B_t^Y = B_t^R - \sigma t\)</span> is a Brownian motion under the dividend reinvested stock numeraire measure. It then follows <span class="math display">\[\frac{R_t}{Y_t} = \frac{R_0}{S_0} \exp\left(-\frac{1}{2} \sigma^2 t - \sigma B_t^Y \right) \]</span></p>
<p>which is an exponential martigale.</p>
</section>
</section>
<section id="derivation-of-the-black-scholes-formula" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="derivation-of-the-black-scholes-formula"><span class="header-section-number">9.3</span> Derivation of the Black-Scholes Formula</h2>
<p>Now we apply the valuation theory from Chapter 3 (Arbitrage Pricing) and the tail probability calculations from Chapter 2 (Geometric Brownian Motion) to derive the Black-Scholes formula.</p>
<section id="cash-digital-options" class="level4">
<h4 class="anchored" data-anchor-id="cash-digital-options">Cash Digital Options</h4>
<p>A cash digital option paying $1 when <span class="math inline">\(S_T &gt; K\)</span> has value under the risk-neutral measure:</p>
<p><span class="math display">\[e^{-r(T-t)} \mathbb{E}_t^R[\mathbf{1}_{\{S_T &gt; K\}}] = e^{-r(T-t)} \text{prob}^R(S_T &gt; K)\]</span></p>
<p>Under the risk-neutral measure, the stock price follows:</p>
<p><span class="math display">\[\frac{\mathrm{d}S}{S} = (r - q) \mathrm{d}t + \sigma \mathrm{d}B^R\]</span></p>
<p>This means:</p>
<p><span class="math display">\[\mathrm{d}\log S = \left(r - q - \frac{\sigma^2}{2}\right) \mathrm{d}t + \sigma \mathrm{d}B^R\]</span></p>
<p>From Chapter 2, we know this has the solution:</p>
<p><span class="math display">\[S_T = S_t \exp\left(\left(r - q - \frac{\sigma^2}{2}\right)(T-t) + \sigma B_{T-t}^R\right) \]</span></p>
<p>Applying the tail probability formula from <a href="Chapter_GeometricBrownianMotion.html#sec-tailprobs" class="quarto-xref"><span>Section 7.2</span></a> with <span class="math inline">\(\alpha = r - q - \sigma^2/2\)</span>:</p>
<p><span class="math display">\[\text{prob}^R(S_T &gt; K) = N(d_2)\]</span></p>
<p>where:</p>
<p><span class="math display">\[d_2 = \frac{\log(S_t/K) + (r - q - \frac{\sigma^2}{2})(T-t)}{\sigma\sqrt{T-t}}\]</span></p>
</section>
<section id="share-digital-options" class="level4">
<h4 class="anchored" data-anchor-id="share-digital-options">Share Digital Options</h4>
<p>For the share digital paying <span class="math inline">\(S_T \mathbf{1}_{\{S_T &gt; K\}}\)</span>, we use the dividend reinvested stock as numeraire. We have</p>
<p><span class="math display">\[S_T  = e^{-q T} Y_T \]</span> therefore <span class="math display">\[\frac{S_T}{Y_T}  \mathbf{1}_{\{S_T &gt; K\}} = e^{-q T}  \mathbf{1}_{\{S_T &gt; K\}}\]</span></p>
<p>From the change of numeraire theory in Chapter 3:</p>
<p><span class="math display">\[\text{Value} = Y_t \mathbb{E}_t^V[e^{-q T} \mathbf{1}_{\{S_T &gt; K\}}] = e^{-q (T-t) } S_t \cdot \text{prob}^Y(S_T &gt; K)\]</span></p>
<p>Under the stock numeraire measure:</p>
<p><span class="math display">\[\mathrm{d}\log S = \left(r - q + \frac{\sigma^2}{2}\right) \mathrm{d}t + \sigma \mathrm{d}B^Y\]</span></p>
<p>Applying the tail probability formula from <a href="Chapter_GeometricBrownianMotion.html#sec-tailprobs" class="quarto-xref"><span>Section 7.2</span></a> with <span class="math inline">\(\alpha = r - q + \sigma^2/2\)</span>:</p>
<p><span class="math display">\[\text{prob}^Y(S_T &gt; K) = N(d_1)\]</span></p>
<p>where:</p>
<p><span class="math display">\[d_1 = \frac{\log(S_t/K) + (r - q + \frac{\sigma^2}{2})(T-t)}{\sigma\sqrt{T-t}} = d_2 + \sigma\sqrt{T-t}\]</span></p>
</section>
<section id="combining-the-results" class="level4">
<h4 class="anchored" data-anchor-id="combining-the-results">Combining the Results</h4>
<p>Now we can derive the Black-Scholes formula by combining our digital option results. A European call option has payoff:</p>
<p><span class="math display">\[(S_T - K)^+ = \mathbf{1}_{\{S_T &gt; K\}} S_T - K \mathbf{1}_{\{S_T &gt; K\}}\]</span></p>
<p>The first term is a share digital worth <span class="math inline">\(e^{-q (T-t)}S_t \cdot \text{prob}^S(S_T &gt; K) = e^{- q (T-t)} S_t N(d_1)\)</span>.</p>
<p>The second term is <span class="math inline">\(K\)</span> cash digitals worth <span class="math inline">\(K \cdot e^{-r(T-t)} \cdot \text{prob}^R(S_T &gt; K) = K e^{-r(T-t)} N(d_2)\)</span>.</p>
<p>We need <span class="math inline">\(e^{-q(T-t)}\)</span> in front of the share digital to account for dividends not paid to the call holder upon exercise, the call value is:</p>
</section>
<section id="the-black-scholes-formula" class="level4">
<h4 class="anchored" data-anchor-id="the-black-scholes-formula">The Black-Scholes Formula</h4>
<p>This derivation shows how the fundamental arbitrage pricing theory leads directly to the Black-Scholes formula. The key steps were:</p>
<ol type="1">
<li><strong>Linear pricing</strong>: From Chapter 3, any security’s value is a linear combination of Arrow securities (digitals)</li>
<li><strong>Change of numeraire</strong>: Different measures give different probabilities for the same event<br>
</li>
<li><strong>Tail probabilities</strong>: From Chapter 2, we can compute <span class="math inline">\(\text{prob}(S_T &gt; K)\)</span> under any measure</li>
<li><strong>Girsanov’s Theorem</strong>: Provides the mathematical foundation for changing measures</li>
</ol>
<div class="callout callout-style-simple callout-Rule callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Result
</div>
</div>
<div class="callout-body-container callout-body">
<p>The value of a European call option is:</p>
<p><span class="math display">\[C(t, S_t) = e^{-q(T-t)} S_t N(d_1) - e^{-r(T-t)} K N(d_2)\]</span></p>
<p>where <span class="math inline">\(d_1\)</span> and <span class="math inline">\(d_2\)</span> are defined above and <span class="math inline">\(N(\cdot)\)</span> is the standard normal cumulative distribution function.</p>
</div>
</div>
<p>The value of a European put option is similarily derived as an exercise :</p>
<div class="callout callout-style-simple callout-Rule callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Result
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[P(t, S_t) = e^{-r(T-t)} K N(-d_2) - e^{-q(T-t)} S_t N(-d_1)\]</span></p>
</div>
</div>
<p>The call and put values satisfy a put-call parity relationship:</p>
<p><span class="math display">\[e^{-r(T-t)} K + C(t, S_t) = e^{-q(T-t)} S_t + P(t, S_t)\]</span></p>
</section>
<section id="interactive-black-scholes-explorer" class="level4">
<h4 class="anchored" data-anchor-id="interactive-black-scholes-explorer">Interactive Black-Scholes Explorer</h4>
<p>The following interactive tool allows you to explore how the Black-Scholes formula behaves as you vary the input parameters. You can see how option prices change with stock price, volatility, time to expiration, interest rates, and dividend yields.</p>
<div id="fig-bs-call-put" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bs-call-put-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<iframe height="800" width="100%" src="https://delicious-britteny-kerrybackapps-c6c2cf93.koyeb.app/">
</iframe>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bs-call-put-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.1: <strong>Black-Scholes Explorer.</strong> This interactive calculator shows how call and put option prices vary with the underlying parameters. Notice how the option prices change smoothly with the stock price, and observe the effects of time-to-maturity and volatility on option values.
</figcaption>
</figure>
</div>
</section>
</section>
<section id="replication-and-delta-hedging" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="replication-and-delta-hedging"><span class="header-section-number">9.4</span> Replication and Delta Hedging</h2>
<p>The Black Scholes formula can also be derived from a no-arbitrage argument since we can replicate option payoffs through dynamic trading. Following Merton’s argument, we construct a portfolio holding <span class="math inline">\(\delta_t\)</span> shares of stock and <span class="math inline">\(\alpha_t\)</span> units of the risk-free asset, with value:</p>
<p><span class="math display">\[W_t = \alpha_t e^{rt} + \delta_t S_t\]</span></p>
<p>For continuous trading with no cash inflows or outflows:</p>
<p><span class="math display">\[\mathrm{d}W_t = \delta_t \mathrm{d}S_t + \delta_t q S_t \mathrm{d}t + \alpha_t r e^{rt} \mathrm{d}t\]</span></p>
<p>If the option value is <span class="math inline">\(C(t, S_t)\)</span>, then by Ito’s lemma:</p>
<p><span class="math display">\[\mathrm{d}C = \frac{\partial C}{\partial t} \mathrm{d}t + \frac{\partial C}{\partial S} \mathrm{d}S + \frac{1}{2} \frac{\partial^2 C}{\partial S^2} \sigma^2 S^2 \mathrm{d}t\]</span></p>
<p>Matching the stochastic terms requires:</p>
<p><span class="math display">\[\delta_t = \frac{\partial C}{\partial S}\]</span></p>
<p>This is the option’s delta—the number of shares needed to hedge the option. Matching the drift terms in both expressions <span class="math display">\[ \frac{\partial C}{\partial S} \mu S_t + \alpha_t r R_t = \frac{\partial C}{\partial t} + \frac{\partial C}{\partial S} (\mu-q) S_t + \frac{1}{2} \frac{\partial^2 C}{\partial S^2} \sigma^2 S_t^2\]</span> which can be solved to give <span class="math display">\[ \alpha_t r R_t=r \left(W_t -\frac{\partial C}{\partial S} S_t\right)  = \frac{\partial C}{\partial t}-\frac{\partial C}{\partial S} q S_t  + \frac{1}{2} \frac{\partial^2 C}{\partial S^2} \sigma^2 S_t^2\]</span> which gives the equation <span class="math display">\[r W_t = \frac{\partial C}{\partial t} + \frac{\partial C}{\partial S}(r-q) S_t+\frac{1}{2} \frac{\partial^2 C}{\partial S^2} \sigma^2 S_t^2\]</span> with a boundary condition <span class="math inline">\(W_T = (S_T-K)^{+}\)</span>. However, no-arbitrage suggests <span class="math inline">\(W_t = C(t,S_t)\)</span> which gives us the partial differential equation <span class="math display">\[r C = \frac{\partial C}{\partial t} + \frac{\partial C}{\partial S} (r-q) S+\frac{1}{2} \frac{\partial^2 C}{\partial S^2} \sigma^2 S^2\]</span> with a boundary condition <span class="math inline">\(C(T,S_T)= (S_T - K)^{+}\)</span>. This is a partial differential equation and a fairly tedious set of calcuations show the Black Scholes formula is a solution (in fact it is the only positive solution). Close observation of the right hand side we see this is the drift term of Ito expansion for <span class="math inline">\(C\)</span> if we work in the risk-neutral probability. The right hand side then says in the risk-neutral probability, the call option earns the risk free return.</p>
<p>However, there is nothing special about a call option. The same argument will apply for any European style option. The only difference is the boundary condition.</p>
<div class="callout callout-style-simple callout-Principle callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important Principle
</div>
</div>
<div class="callout-body-container callout-body">
<p>The price <span class="math inline">\(V(S_t,t)\)</span> of any European derivative with payoff <span class="math inline">\(V(S_T)\)</span> at maturity <span class="math inline">\(T\)</span> must satisfy:</p>
<p><span class="math display">\[r V = \frac{\partial V}{\partial t} + \frac{\partial V }{\partial S}(r - q)S + \frac{1}{2} \frac{\partial^2 V}{\partial S^2} \sigma^2 S^2\]</span></p>
<p>with boundary condition <span class="math inline">\(V(S_T, T) = V(S_T)\)</span>.</p>
</div>
</div>
<p>This PDE has several important interpretations:</p>
<ol type="1">
<li><strong>Risk-neutral expectation</strong>: The solution is <span class="math inline">\(V(t, S_t) = \mathbb{E}_t^R[e^{-r(T-t)} V(S_T)]\)</span>. This sometimes called the Feynman Kac Theorem.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li><strong>Replication</strong>: The portfolio holds <span class="math inline">\(\frac{\partial V}{\partial S}\)</span> shares and <span class="math inline">\(V - \frac{\partial V}{\partial S}S\)</span> in cash</li>
<li><strong>Hedging condition</strong>: The drift term equals the risk-free return when perfectly hedged</li>
</ol>
<p>The Black-Scholes formula satisfies this PDE with the appropriate boundary conditions for calls and puts.</p>
<section id="simulating-portfolio-insurance" class="level4">
<h4 class="anchored" data-anchor-id="simulating-portfolio-insurance">Simulating Portfolio Insurance</h4>
<p>Recall, that a protective put position buys a put and buys a share and the payoff at the expiration of the put is given by <span class="math inline">\(\max(K,S_T)\)</span>. The reason for the name protective put is apparent since the position can pay off no less than <span class="math inline">\(K\)</span>. The cost of this insurance is the price of the put. However, if the put is not traded, we can synthetically replicate this payoff using the prodedure above assuming we can trade continuously. The basic recipe is to start with inital wealth equal to that for a protective put position: <span class="math inline">\(W_0 = P(0,S_0)+S_0\)</span>. The delta of the protective put position can be calcuated to be the delta of the put plus 1 which is <span class="math inline">\(N(d_1)\)</span>, where <span class="math inline">\(d_1\)</span> is calculated at each point in time. However, in practice we cannot trade continuously. A simple discrete strategy would rebalance at intervals <span class="math inline">\(\Delta t\)</span>. The strategy calculates <span class="math inline">\(N(d_1)\)</span> at time 0 and holds <span class="math inline">\(P(0,S_0)+S_0 - N(d_1)S_0\)</span> dollars in the risk free asset and <span class="math inline">\(N(d_1)\)</span> shares of the asset. Thereafter these holdings are adjusted. The change in portfolio value over the interval <span class="math inline">\(\Delta t\)</span> is <span class="math display">\[\Delta W= W_{i \Delta t}- W_{(i-1)\Delta t} \]</span> <span class="math display">\[
= (P((i-1)\Delta t,S_{(i-1)\Delta t})+S_{(i-1)\Delta t} - N(d_1-)S_{(i-1)\Delta t})(R_{i\Delta t}-R_{(i-1)\Delta t}) + N(d1-)(S_{i\Delta t}-S_{(i-1)\Delta t})
\]</span> where <span class="math inline">\(N(d1-)\)</span> is the delta chosen at time <span class="math inline">\((i-1)\Delta t\)</span>. The question is if the Black Scoles model is correct, how accurate can a discrete rebalancing scheme be? This is simulated in the following code:</p>
<div id="06b6bd41" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from bsfunctions import *</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> <span class="bu">pow</span>, exp, sqrt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># incs = np.genfromtxt('incs.csv',delimiter=",",skip_header=1)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blackscholes(S0, K, r, q, sig, T, call <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Calculate option price using B-S formula.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">        S0 (num): initial price of underlying asset.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">        K (num): strick price.</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">        r (num): risk free rate.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">        q (num): dividend yield</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">        sig (num): Black-Scholes volatility.</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">        T (num): maturity.</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">        call (bool): True returns call price, False returns put price.</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">        num</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S0<span class="op">/</span>K) <span class="op">+</span> (r <span class="op">-</span>q <span class="op">+</span> sig<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> T)<span class="op">/</span>(sig<span class="op">*</span>np.sqrt(T))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> d1 <span class="op">-</span> sig<span class="op">*</span>np.sqrt(T)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     norm = sp.stats.norm</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> stats.norm</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call:</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>S0 <span class="op">*</span> norm.cdf(d1,<span class="dv">0</span>,<span class="dv">1</span>) <span class="op">-</span> K <span class="op">*</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> norm.cdf(d2,<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>S0 <span class="op">*</span> <span class="op">-</span>norm.cdf(<span class="op">-</span>d1,<span class="dv">0</span>,<span class="dv">1</span>) <span class="op">+</span> K <span class="op">*</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> norm.cdf(<span class="op">-</span>d2,<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blackscholes_delta(S0, K, r, q, sig, T, call <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Calculate option price using B-S formula.</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">        S0 (num): initial price of underlying asset.</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">        K (num): strick price.</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">        r (num): risk free rate.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">        q (num): dividend yield</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">        sig (num): Black-Scholes volatility.</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">        T (num): maturity.</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">        call (bool): True returns call price, False returns put price.</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co">        num</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S0<span class="op">/</span>K) <span class="op">+</span> (r <span class="op">-</span>q <span class="op">+</span> sig<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> T)<span class="op">/</span>(sig<span class="op">*</span>np.sqrt(T))</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> d1 <span class="op">-</span> sig<span class="op">*</span>np.sqrt(T)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co">#     norm = sp.stats.norm</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> stats.norm</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(call) <span class="op">==</span> <span class="bu">bool</span>:</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> call:</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>norm.cdf(d1,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>norm.cdf(<span class="op">-</span>d1,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Not a valid value for call"</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># number of paths</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># n = incs.shape[1]</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co"># number of divisions</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># m = incs.shape[0]</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># interest rate</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="fl">.1</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># dividend yield</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>q<span class="op">=</span><span class="fl">0.0</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># true drift</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="fl">.15</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># volatility</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>sig <span class="op">=</span> <span class="fl">.2</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial Stock Price</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>S0 <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Strike Price</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Maturity</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="co"># seed for random generator</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>seed<span class="op">=</span> <span class="dv">1234</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># define a random generator</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>rg <span class="op">=</span> np.random.RandomState(seed)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="co"># generate normal random vairables</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>dt<span class="op">=</span> T<span class="op">/</span>m</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>vol<span class="op">=</span>sig<span class="op">*</span>np.sqrt(dt)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>incs <span class="op">=</span> rg.normal(<span class="dv">0</span>,vol,[m,n])</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>tline <span class="op">=</span> np.linspace(<span class="dv">0</span>,T,m<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>St <span class="op">=</span> np.zeros((m<span class="op">+</span><span class="dv">1</span>,n))</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co">#St1 = np.zeros((m+1,n))</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>V_vec <span class="op">=</span> np.zeros((m<span class="op">+</span><span class="dv">1</span>,n))</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>delta <span class="op">=</span> np.zeros((m,n))</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>put<span class="op">=</span> blackscholes(S0,K,r, q, sig,T,call<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>incs_cumsum <span class="op">=</span>  np.concatenate((np.zeros((<span class="dv">1</span>,n)),incs),axis<span class="op">=</span><span class="dv">0</span>).cumsum(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>V_vec <span class="op">=</span> np.zeros((m<span class="op">+</span><span class="dv">1</span>,n))</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>t_mat <span class="op">=</span>  np.repeat(tline.reshape((m<span class="op">+</span><span class="dv">1</span>,<span class="dv">1</span>)), n, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>drift_cumsum <span class="op">=</span> (mu <span class="op">-</span>q <span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>sig<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> t_mat</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>St <span class="op">=</span> S0 <span class="op">*</span> np.exp(incs_cumsum <span class="op">+</span> drift_cumsum)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>delta <span class="op">=</span> blackscholes_delta(St[:<span class="op">-</span><span class="dv">1</span>,:],K,r, q, sig,T<span class="op">-</span>t_mat[:<span class="op">-</span><span class="dv">1</span>,:])</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>V_vec[<span class="dv">0</span>,:] <span class="op">=</span> S0 <span class="op">+</span> put</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,m<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    V_vec[i,:] <span class="op">=</span> V_vec[i<span class="op">-</span><span class="dv">1</span>,:] <span class="op">+</span> (np.exp(r<span class="op">*</span>dt)<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> (V_vec[i<span class="op">-</span><span class="dv">1</span>,:] <span class="op">-</span> delta[i<span class="op">-</span><span class="dv">1</span>,:] <span class="op">*</span> St[i<span class="op">-</span><span class="dv">1</span>,:])<span class="op">+</span> delta[i<span class="op">-</span><span class="dv">1</span>,:] <span class="op">*</span> (St[i,:]<span class="op">-</span>St[i<span class="op">-</span><span class="dv">1</span>,:])</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Uses actual simulated changes in riskfree and stock price not the dt and dB approximations </span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co"># plot ST versus VT</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>plt.scatter(St[m,:],V_vec[m,:])</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Stock Price at Maturity'</span>)</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Value of Portfolio Insurance'</span>)</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter_BlackScholes_files/figure-html/cell-3-output-1.png" width="585" height="282" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>With <span class="math inline">\(m=100\)</span> rebalancing dates over <span class="math inline">\(T=0.5\)</span> for the parameters chosen the repliacting strategy does a pretty good job. The hedging errors occur when the stock price is close to the strike price. This is not surprising since the delta changes (measured by the gamma) fastest around this point. A gamma hedge would potentially improve the performance.</p>
<p>The portfolio insurance rebalancing scheme involves sell stock and buying bonds when the stock price goes down and buying stocks and selling bonds when the stock price goes up. This can be destabilizing and was identified as a contributor to the 1987 stock market crash.</p>
</section>
</section>
<section id="greeks" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="greeks"><span class="header-section-number">9.5</span> Greeks</h2>
<p>The sensitivities of option values to various inputs are called Greeks. From the Black-Scholes formula:</p>
<section id="delta-delta" class="level4">
<h4 class="anchored" data-anchor-id="delta-delta">Delta (<span class="math inline">\(\delta\)</span>)</h4>
<p>The sensitivity to stock price changes:</p>
<p><span class="math display">\[\delta_{call} = e^{-q(T-t)} N(d_1)\]</span> <span class="math display">\[\delta_{put} = -e^{-q(T-t)} N(-d_1)\]</span></p>
</section>
<section id="gamma-gamma" class="level4">
<h4 class="anchored" data-anchor-id="gamma-gamma">Gamma (<span class="math inline">\(\Gamma\)</span>)</h4>
<p>The rate of change of delta:</p>
<p><span class="math display">\[\Gamma = \frac{e^{-q(T-t)} n(d_1)}{S \sigma \sqrt{T-t}}\]</span></p>
<p>where <span class="math inline">\(n(\cdot)\)</span> is the standard normal density. Gamma is the same for calls and puts.</p>
</section>
<section id="theta-theta" class="level4">
<h4 class="anchored" data-anchor-id="theta-theta">Theta (<span class="math inline">\(\Theta\)</span>)</h4>
<p>The time decay (using <span class="math inline">\(\partial/\partial(-T)\)</span> so positive theta means value increases as time passes):</p>
<p><span class="math display">\[\Theta_{call} = -\frac{e^{-q(T-t)} S n(d_1) \sigma}{2\sqrt{T-t}} + q e^{-q(T-t)} S N(d_1) - r e^{-r(T-t)} K N(d_2)\]</span></p>
</section>
<section id="vega-mathcalv" class="level4">
<h4 class="anchored" data-anchor-id="vega-mathcalv">Vega (<span class="math inline">\(\mathcal{V}\)</span>)</h4>
<p>The sensitivity to volatility:</p>
<p><span class="math display">\[\mathcal{V} = e^{-q(T-t)} S n(d_1) \sqrt{T-t}\]</span></p>
</section>
<section id="rho-rho" class="level4">
<h4 class="anchored" data-anchor-id="rho-rho">Rho (<span class="math inline">\(\rho\)</span>)</h4>
<p>The sensitivity to interest rates:</p>
<p><span class="math display">\[\rho_{call} = (T-t) e^{-r(T-t)} K N(d_2)\]</span></p>
</section>
<section id="interactive-greeks-explorer" class="level4">
<h4 class="anchored" data-anchor-id="interactive-greeks-explorer">Interactive Greeks Explorer</h4>
<p>The Greeks measure how option prices change with respect to various parameters. The following interactive tool lets you visualize how the Greeks behave across different stock prices and parameter values.</p>
<div id="fig-bs-greeks" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bs-greeks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<iframe height="750" width="100%" src="https://greeks.koyeb.app/">
</iframe>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bs-greeks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.2: <strong>Black-Scholes Greeks Explorer.</strong> This tool shows how delta, gamma, theta, vega, and rho vary with the stock price and other parameters. Pay particular attention to how gamma peaks near the strike price and how theta becomes more negative as expiration approaches.
</figcaption>
</figure>
</div>
</section>
</section>
<section id="theta-and-gamma-in-delta-hedges" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="theta-and-gamma-in-delta-hedges"><span class="header-section-number">9.6</span> Theta and Gamma in Delta Hedges</h2>
<p>The relationship between theta and gamma provides deep insight into option hedging. Consider a delta-hedged portfolio (short call, long <span class="math inline">\(\delta\)</span> shares). From the fundamental PDE and our Greeks:</p>
<p><span class="math display">\[\Theta + \frac{1}{2} \Gamma \sigma^2 S^2 = r C - (r - q) S \delta\]</span></p>
<p>In continuous time, the portfolio change is:</p>
<p><span class="math display">\[-\Theta \mathrm{d}t - \frac{1}{2} \Gamma \sigma^2 S^2 \mathrm{d}t + q \delta S \mathrm{d}t + (C - \delta S) r \mathrm{d}t\]</span></p>
<p>These terms exactly cancel—the time decay and dividends received offset losses from being short gamma and interest payments. This perfect cancellation only holds with continuous rebalancing.</p>
<p>With discrete rebalancing, the hedge is imperfect. The portfolio is short gamma, meaning it loses money when the stock moves significantly between rebalances. This loss is approximately:</p>
<p><span class="math display">\[\frac{1}{2} \Gamma (\Delta S)^2\]</span></p>
<p>where <span class="math inline">\(\Delta S\)</span> is the stock price change. The hedging error increases with:</p>
<ul>
<li>Larger gamma (near the strike at expiration)</li>
<li>Higher volatility</li>
<li>Longer time between rebalances</li>
</ul>
<section id="discretely-rebalanced-delta-hedges" class="level4">
<h4 class="anchored" data-anchor-id="discretely-rebalanced-delta-hedges">Discretely Rebalanced Delta Hedges</h4>
<p>The theoretical analysis above assumes continuous rebalancing, but in practice, hedging must be done at discrete intervals. This introduces hedging error that we can analyze through simulation.</p>
</section>
<section id="the-discrete-hedging-problem" class="level4">
<h4 class="anchored" data-anchor-id="the-discrete-hedging-problem">The Discrete Hedging Problem</h4>
<p>Consider a delta hedge that is rebalanced at discrete times <span class="math inline">\(0 = t_0 &lt; t_1 &lt; \cdots &lt; t_N = T\)</span> with <span class="math inline">\(\Delta t = T/N\)</span>. Between rebalancing dates, the hedge portfolio consists of:</p>
<ul>
<li>Short position in the option</li>
<li>Long <span class="math inline">\(\delta_{t_i}\)</span> shares of stock (where <span class="math inline">\(\delta_{t_i}\)</span> is computed at the last rebalancing date)</li>
<li>Cash position to finance the hedge</li>
</ul>
<p>The key insight from the analysis in <span class="quarto-unresolved-ref">?sec-s_deltahedging</span> is that perfect continuous hedging relies on the relationship:</p>
<p><span class="math display">\[-\Theta \,\mathrm{d} t - \frac{1}{2}\Gamma \sigma^2S^2\,\mathrm{d} t+ q \delta S\,\mathrm{d} t+(C-\delta S)r\,\mathrm{d} t = 0\]</span></p>
<p>With discrete rebalancing, this balance is disrupted. The portfolio gains and losses come from:</p>
<ol type="1">
<li><strong>Time decay</strong>: <span class="math inline">\(-\Theta \Delta t\)</span> (predictable, typically positive for short option)</li>
<li><strong>Gamma exposure</strong>: <span class="math inline">\(-\frac{1}{2}\Gamma (\Delta S)^2\)</span> (stochastic losses when short gamma)</li>
<li><strong>Interest and dividends</strong>: Financing costs and dividend income</li>
<li><strong>Delta drift</strong>: Changes in delta between rebalancing dates</li>
</ol>
</section>
<section id="simulation-of-discrete-hedging" class="level4">
<h4 class="anchored" data-anchor-id="simulation-of-discrete-hedging">Simulation of Discrete Hedging</h4>
<p>The following code simulates the performance of discretely rebalanced delta hedges. It runs 10,000 simulations of a stock price path, with trading to an updated delta hedge each period.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div id="13c72539" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> jit</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blackscholes(S0, K, r, q, sig, T, call <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Calculate option price using Black-Scholes formula.'''</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S0<span class="op">/</span>K) <span class="op">+</span> (r <span class="op">-</span>q <span class="op">+</span> sig<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> T)<span class="op">/</span>(sig<span class="op">*</span>np.sqrt(T))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> d1 <span class="op">-</span> sig<span class="op">*</span>np.sqrt(T)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>S0 <span class="op">*</span> norm.cdf(d1,<span class="dv">0</span>,<span class="dv">1</span>) <span class="op">-</span> K <span class="op">*</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> norm.cdf(d2,<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>S0 <span class="op">*</span> (<span class="op">-</span>norm.cdf(<span class="op">-</span>d1,<span class="dv">0</span>,<span class="dv">1</span>)) <span class="op">+</span> K <span class="op">*</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> norm.cdf(<span class="op">-</span>d2,<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blackscholes_delta(S0, K, r, q, sig, T, call <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Calculate option delta using Black-Scholes formula.'''</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S0<span class="op">/</span>K) <span class="op">+</span> (r <span class="op">-</span>q <span class="op">+</span> sig<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> T)<span class="op">/</span>(sig<span class="op">*</span>np.sqrt(T))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>norm.cdf(d1,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>q<span class="op">*</span>T)<span class="op">*</span>norm.cdf(<span class="op">-</span>d1,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm_cdf_fast(x):</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Fast approximation of cumulative normal distribution.</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Accurate to about 7 decimal places using Abramowitz &amp; Stegun approximation.</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Constants for the approximation</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    a1 <span class="op">=</span>  <span class="fl">0.254829592</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    a2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.284496736</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    a3 <span class="op">=</span>  <span class="fl">1.421413741</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    a4 <span class="op">=</span> <span class="op">-</span><span class="fl">1.453152027</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    a5 <span class="op">=</span>  <span class="fl">1.061405429</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    p  <span class="op">=</span>  <span class="fl">0.3275911</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the sign of x</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    sign <span class="op">=</span> <span class="fl">1.0</span> <span class="cf">if</span> x <span class="op">&gt;=</span> <span class="fl">0.0</span> <span class="cf">else</span> <span class="op">-</span><span class="fl">1.0</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="bu">abs</span>(x) <span class="op">/</span> np.sqrt(<span class="fl">2.0</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Abramowitz &amp; Stegun formula</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">+</span> p <span class="op">*</span> x)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> (((((a5 <span class="op">*</span> t <span class="op">+</span> a4) <span class="op">*</span> t) <span class="op">+</span> a3) <span class="op">*</span> t <span class="op">+</span> a2) <span class="op">*</span> t <span class="op">+</span> a1) <span class="op">*</span> t <span class="op">*</span> np.exp(<span class="op">-</span>x <span class="op">*</span> x)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">+</span> sign <span class="op">*</span> y)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blackscholes_delta_fast(S, K, r, q, sigma, T):</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fast Black-Scholes delta for call option using Numba."""</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> T <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> S <span class="op">&gt;</span> K <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S <span class="op">/</span> K) <span class="op">+</span> (r <span class="op">-</span> q <span class="op">+</span> sigma<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> T) <span class="op">/</span> (sigma <span class="op">*</span> np.sqrt(T))</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.exp(<span class="op">-</span>q <span class="op">*</span> T) <span class="op">*</span> norm_cdf_fast(d1)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_single_path(S0, K, r, sigma, q, T, mu, N, drift, vol_dt,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                        discount, div_factor, delta_0, cash_0, random_normals):</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate a single delta hedge path.</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimized with Numba JIT compilation.</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> T <span class="op">/</span> N</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    log_s <span class="op">=</span> np.log(S0)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> cash_0</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> S0</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> delta_0</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rebalancing loop</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, N):</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stock price evolution</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>        log_s <span class="op">+=</span> drift <span class="op">+</span> vol_dt <span class="op">*</span> random_normals[j]</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>        new_s <span class="op">=</span> np.exp(log_s)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># New delta for rebalancing</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        time_remaining <span class="op">=</span> T <span class="op">-</span> j <span class="op">*</span> dt</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        new_delta <span class="op">=</span> blackscholes_delta_fast(new_s, K, r, q, sigma, time_remaining)</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update cash position: interest + dividends - rebalancing cost</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">=</span> (discount <span class="op">*</span> cash <span class="op">+</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>               delta <span class="op">*</span> s <span class="op">*</span> div_factor <span class="op">-</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>               (new_delta <span class="op">-</span> delta) <span class="op">*</span> new_s)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> new_s</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>        delta <span class="op">=</span> new_delta</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final period</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    log_s <span class="op">+=</span> drift <span class="op">+</span> vol_dt <span class="op">*</span> random_normals[N]</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    final_s <span class="op">=</span> np.exp(log_s)</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final hedge value</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    final_hedge_value <span class="op">=</span> (discount <span class="op">*</span> cash <span class="op">+</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>                       delta <span class="op">*</span> s <span class="op">*</span> div_factor <span class="op">+</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>                       delta <span class="op">*</span> final_s)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Profit = hedge value - option payoff</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    option_payoff <span class="op">=</span> <span class="bu">max</span>(final_s <span class="op">-</span> K, <span class="fl">0.0</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_hedge_value <span class="op">-</span> option_payoff</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_all_simulations(S0, K, r, sigma, q, T, mu, M, N, drift, vol_dt,</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>                       discount, div_factor, delta_0, cash_0, all_random_normals):</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run all M simulations using Numba JIT."""</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    profits <span class="op">=</span> np.zeros(M)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(M):</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>        profits[i] <span class="op">=</span> simulate_single_path(</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>            S0, K, r, sigma, q, T, mu, N, drift, vol_dt,</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>            discount, div_factor, delta_0, cash_0, all_random_normals[i, :]</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> profits</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulated_delta_hedge_profit(S0, K, r, sigma, q, T, mu, M, N, pct):</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate profits/losses from discretely rebalanced delta hedge.</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimized version using Numba JIT compilation.</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a><span class="co">    S0: initial stock price</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a><span class="co">    K: strike price</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a><span class="co">    r: risk-free rate</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="co">    sigma: volatility</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a><span class="co">    q: dividend yield</span></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a><span class="co">    T: time to maturity</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a><span class="co">    mu: expected stock return (actual, not risk-neutral)</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a><span class="co">    M: number of simulations</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a><span class="co">    N: number of rebalancing periods</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a><span class="co">    pct: percentile to return</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> T <span class="op">/</span> N</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>    vol_dt <span class="op">=</span> sigma <span class="op">*</span> np.sqrt(dt)</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    drift <span class="op">=</span> (mu <span class="op">-</span> q <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> dt</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    discount <span class="op">=</span> np.exp(r <span class="op">*</span> dt)</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    div_factor <span class="op">=</span> np.exp(q <span class="op">*</span> dt) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial setup (using scipy for initial values)</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    call_0 <span class="op">=</span> blackscholes(S0, K, r, q, sigma, T, <span class="va">True</span>)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    delta_0 <span class="op">=</span> blackscholes_delta(S0, K, r, q, sigma, T, <span class="va">True</span>)</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>    cash_0 <span class="op">=</span> call_0 <span class="op">-</span> delta_0 <span class="op">*</span> S0</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate all random numbers upfront for better performance</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    all_random_normals <span class="op">=</span> np.random.randn(M, N <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run all simulations using JIT-compiled function</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    profits <span class="op">=</span> run_all_simulations(</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>        S0, K, r, sigma, q, T, mu, M, N, drift, vol_dt,</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>        discount, div_factor, delta_0, cash_0, all_random_normals</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.percentile(profits, pct <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Hedge a call option with discrete rebalancing</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>S0 <span class="op">=</span> <span class="dv">100</span>      <span class="co"># Initial stock price</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">100</span>       <span class="co"># Strike price (at-the-money)</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="fl">0.05</span>      <span class="co"># Risk-free rate</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.2</span>   <span class="co"># Volatility</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="fl">0.02</span>      <span class="co"># Dividend yield</span></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">0.25</span>      <span class="co"># 3 months to maturity</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="fl">0.12</span>     <span class="co"># Expected stock return</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Discrete Delta Hedging Analysis"</span>)</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=============================="</span>)</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Parameters: S0=</span><span class="sc">{</span>S0<span class="sc">}</span><span class="ss">, K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">, r=</span><span class="sc">{</span>r<span class="sc">:.2f}</span><span class="ss">, σ=</span><span class="sc">{</span>sigma<span class="sc">:.2f}</span><span class="ss">, q=</span><span class="sc">{</span>q<span class="sc">:.2f}</span><span class="ss">, T=</span><span class="sc">{</span>T<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected stock return μ=</span><span class="sc">{</span>mu<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Test different rebalancing frequencies</span></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>rebalancing_frequencies <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">13</span>, <span class="dv">63</span>]  </span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">10000</span>  <span class="co"># Number of simulations</span></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Hedging Error Analysis (95th percentile of absolute profits):"</span>)</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rebalancing Frequency | Periods | 95th Percentile Error"</span>)</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">55</span>)</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> N <span class="kw">in</span> rebalancing_frequencies:</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get both tails of the distribution</span></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>    p95 <span class="op">=</span> simulated_delta_hedge_profit(S0, K, r, sigma, q, T, mu, M, N, <span class="fl">0.95</span>)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>    p5 <span class="op">=</span> simulated_delta_hedge_profit(S0, K, r, sigma, q, T, mu, M, N, <span class="fl">0.05</span>)</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Report the larger absolute error</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>    max_error <span class="op">=</span> <span class="bu">max</span>(<span class="bu">abs</span>(p95), <span class="bu">abs</span>(p5))</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>    freq_name <span class="op">=</span> {<span class="dv">3</span>: <span class="st">"Monthly"</span>, <span class="dv">13</span>: <span class="st">"Weekly"</span>, <span class="dv">63</span>: <span class="st">"Daily"</span>}[N]</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>freq_name<span class="sc">:&lt;20}</span><span class="ss"> | </span><span class="sc">{</span>N<span class="sc">:&gt;7}</span><span class="ss"> | </span><span class="sc">{</span>max_error<span class="sc">:&gt;18.4f}</span><span class="ss">"</span>)</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Note: Errors should decrease as rebalancing frequency increases."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Discrete Delta Hedging Analysis
==============================
Parameters: S0=100, K=100, r=0.05, σ=0.20, q=0.02, T=0.25
Expected stock return μ=0.12

Hedging Error Analysis (95th percentile of absolute profits):
Rebalancing Frequency | Periods | 95th Percentile Error
-------------------------------------------------------
Monthly              |       3 |             3.2002
Weekly               |      13 |             1.5593
Daily                |      63 |             0.7157

Note: Errors should decrease as rebalancing frequency increases.</code></pre>
</div>
</div>
</section>
</section>
<section id="implied-volatilities" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="implied-volatilities"><span class="header-section-number">9.7</span> Implied Volatilities</h2>
<p>While all other Black-Scholes inputs are observable, volatility must be estimated. Given an option’s market price, we can invert the Black-Scholes formula to find the implied volatility—the <span class="math inline">\(\sigma\)</span> that produces the observed price.</p>
<p>Implied volatilities serve several purposes:</p>
<ol type="1">
<li><strong>Price quotes</strong>: Options are often quoted in terms of implied volatility</li>
<li><strong>Relative value</strong>: Comparing implied volatilities helps identify expensive or cheap options</li>
<li><strong>Market views</strong>: Implied volatilities reflect market expectations of future volatility</li>
</ol>
<section id="the-volatility-smile" class="level4">
<h4 class="anchored" data-anchor-id="the-volatility-smile">The Volatility Smile</h4>
<p>If the Black-Scholes model were perfect, all options with the same maturity would have the same implied volatility. In practice, plotting implied volatility against strike typically shows:</p>
<ul>
<li>Higher implied volatilities for low strikes (out-of-the-money puts)</li>
<li>Lower implied volatilities near the at-the-money strike</li>
<li>Slightly increasing implied volatilities for high strikes</li>
</ul>
<p>This “volatility smile” or “smirk” indicates that market prices reflect: - Fat tails: Higher probability of extreme moves than lognormal - Negative skewness: Larger probability of extreme downward moves</p>
<p>The smile has been particularly pronounced for equity index options since the 1987 crash, suggesting market participants price in crash risk.</p>
</section>
</section>
<section id="exercises" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="exercises"><span class="header-section-number">9.8</span> Exercises</h2>
<section id="digital-options-and-building-blocks" class="level4">
<h4 class="anchored" data-anchor-id="digital-options-and-building-blocks">Digital Options and Building Blocks</h4>
<div id="exr-digital-pricing" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.1</strong></span> Consider a cash digital option that pays $1 when <span class="math inline">\(S_T &gt; K\)</span> and a share digital that pays <span class="math inline">\(S_T\)</span> when <span class="math inline">\(S_T &gt; K\)</span>. Using Black-Scholes parameters <span class="math inline">\(S_0 = 100\)</span>, <span class="math inline">\(K = 105\)</span>, <span class="math inline">\(r = 5\%\)</span>, <span class="math inline">\(q = 2\%\)</span>, <span class="math inline">\(\sigma = 20\%\)</span>, <span class="math inline">\(T = 0.25\)</span>:</p>
<ol type="a">
<li>Calculate the analytical values of both digital options using the formulas from the chapter</li>
<li>Verify your results using Monte Carlo simulation with 100,000 paths</li>
<li>Show that a call option can be decomposed as: <span class="math inline">\(C = S_0 N(d_1) e^{-qT} - K N(d_2) e^{-rT}\)</span></li>
<li>Implement this decomposition and verify it matches the standard Black-Scholes formula</li>
</ol>
</div>
<div id="exr-digital-delta" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.2</strong></span> The delta of a cash digital option that pays $1 when <span class="math inline">\(S_T &gt; K\)</span> is: <span class="math display">\[\Delta_{\text{digital}} = \frac{e^{-rT} n(d_2)}{\sigma S \sqrt{T}}\]</span></p>
<p>where <span class="math inline">\(n(\cdot)\)</span> is the standard normal density.</p>
<ol type="a">
<li>Plot this delta against stock price for <span class="math inline">\(S \in [80, 120]\)</span> with the parameters from the previous exercise</li>
<li>Compare the magnitude of digital delta to call option delta near the strike</li>
<li>Explain why delta hedging a short digital position near expiration and near the strike is problematic</li>
<li>What happens to the digital delta as time to expiration approaches zero?</li>
</ol>
</div>
<p>::: {#digital puts} The following two questions can be answered in two ways.</p>
<p>What is the vaule of a derivative security which pays <span class="math display">\[\mathbf{1}_{\{S_T &lt;K\}}\]</span></p>
<p>What is the value of a derivative security which pays <span class="math display">\[ S_T \mathbf{1}_{\{S_T &lt;K\}}\]</span></p>
<p>:::</p>
</section>
<section id="change-of-numeraire-and-girsanovs-theorem" class="level4">
<h4 class="anchored" data-anchor-id="change-of-numeraire-and-girsanovs-theorem">Change of Numeraire and Girsanov’s Theorem</h4>
<div id="exr-measure-verification" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.3</strong></span> Using simulation, verify the change of numeraire formulas for digital options:</p>
<ol type="a">
<li>Under the risk-neutral measure, simulate <span class="math inline">\(S_T\)</span> following <span class="math inline">\(dS/S = (r-q)dt + \sigma dB^R\)</span></li>
<li>Under the stock numeraire measure, simulate <span class="math inline">\(S_T\)</span> following <span class="math inline">\(dS/S = (r-q+\sigma^2)dt + \sigma dB^S\)</span><br>
</li>
<li>Calculate <span class="math inline">\(\mathbb{E}^R[e^{-rT} \mathbf{1}_{\{S_T &gt; K\}}]\)</span> and <span class="math inline">\(S_0 \mathbb{E}^S[\mathbf{1}_{\{S_T &gt; K\}}/S_T]\)</span></li>
<li>Verify both give the same digital option value up to simulation error</li>
<li>Use 50,000 simulation paths and report the standard errors</li>
</ol>
</div>
<div id="exr-girsanov-application" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.4</strong></span> Verify the exponential martingale property in Girsanov’s Theorem. With <span class="math inline">\(\kappa = (\mu - r)/\sigma\)</span>:</p>
<ol type="a">
<li>Simulate paths of <span class="math inline">\(Z_t = \exp(-\frac{1}{2}\kappa^2 t - \kappa B_t)\)</span> where <span class="math inline">\(B_t\)</span> is standard Brownian motion</li>
<li>Verify that <span class="math inline">\(\mathbb{E}[Z_T] = 1\)</span> for various values of <span class="math inline">\(T\)</span></li>
<li>Show that <span class="math inline">\(Z_t S_t/R_t\)</span> is a martingale under the original measure</li>
<li>Compare the distribution of <span class="math inline">\(B_t + \kappa t\)</span> to standard Brownian motion under the new measure</li>
</ol>
</div>
</section>
<section id="black-scholes-formula-and-properties" class="level4">
<h4 class="anchored" data-anchor-id="black-scholes-formula-and-properties">Black-Scholes Formula and Properties</h4>
<div id="exr-bs-implementation" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.5</strong></span> Implement the complete Black-Scholes formula with all Greeks:</p>
<ol type="a">
<li>Create a Python class <code>BlackScholesOption</code> that calculates price, delta, gamma, theta, vega, and rho</li>
<li>Include both calls and puts with proper dividend yield handling</li>
<li>Verify put-call parity: <span class="math inline">\(C - P = S_0 e^{-qT} - K e^{-rT}\)</span></li>
<li>Test your implementation against the interactive Black-Scholes explorer values</li>
</ol>
</div>
<div id="exr-bs-limits" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.6</strong></span> Analyze the limiting behavior of the Black-Scholes formula:</p>
<ol type="a">
<li>Show that as <span class="math inline">\(T \to 0\)</span>, the call value approaches <span class="math inline">\(\max(S_0 - K, 0)\)</span></li>
<li>Show that as <span class="math inline">\(\sigma \to 0\)</span>, the formula approaches the deterministic payoff present value</li>
<li>What happens to call and put values as <span class="math inline">\(\sigma \to \infty\)</span>? Explain intuitively.</li>
<li>Analyze the behavior as <span class="math inline">\(r \to 0\)</span> and as <span class="math inline">\(r \to \infty\)</span></li>
</ol>
</div>
<div id="exr-volatility-impact" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.7</strong></span> Using the interactive Black-Scholes explorer or your own implementation:</p>
<ol type="a">
<li>For an at-the-money option, plot call value against volatility for <span class="math inline">\(\sigma \in [0.1, 1.0]\)</span></li>
<li>Repeat for options that are 10% in-the-money and 10% out-of-the-money</li>
<li>For which moneyness is the option price most sensitive to volatility changes?</li>
<li>Explain this pattern in terms of the option’s probability of finishing in-the-money</li>
</ol>
</div>
</section>
<section id="greeks-and-risk-management" class="level4">
<h4 class="anchored" data-anchor-id="greeks-and-risk-management">Greeks and Risk Management</h4>
<div id="exr-greeks-plots" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.8</strong></span> Create comprehensive plots of the Greeks using the interactive Greeks explorer as reference:</p>
<ol type="a">
<li>Plot delta, gamma, theta, vega, and rho against stock price for an at-the-money option</li>
<li>Repeat for different times to expiration: 1 month, 3 months, 6 months, 1 year</li>
<li>Identify where gamma is maximized and explain why this matters for hedging</li>
<li>Show how theta changes as expiration approaches and explain the time decay acceleration</li>
</ol>
</div>
<div id="exr-gamma-hedging" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.9</strong></span> Consider delta and gamma hedging a short call option using the underlying and a put with the same strike and maturity:</p>
<ol type="a">
<li>Derive the positions in stock and put needed for a delta-gamma neutral portfolio</li>
<li>Show that this hedge never needs adjustment (relate to put-call parity)</li>
<li>Implement this strategy and compare hedging errors to delta-only hedging</li>
<li>What are the practical limitations of this “perfect” hedge?</li>
</ol>
</div>
</section>
<section id="the-fundamental-pde-and-replication" class="level4">
<h4 class="anchored" data-anchor-id="the-fundamental-pde-and-replication">The Fundamental PDE and Replication</h4>
<div id="PDE00">
<p>Show that the stock price and the boond price satisfy the fundamental PDE with the appropriate boundary condition.</p>
</div>
<div id="PDE0">
<p>Show that the share digital and cash digital prices satisfy the fundamenatl PDE with the appropriate boundary condition.</p>
</div>
<div id="PDE1">
<p>Use risk neutral valuation to find the value of a derivative security which pays <span class="math inline">\(\ln(S_T)\)</span>. Verify your value satisfies the fundamental PDE with the appropriate boundary condition. What is the replicating portfolio? Is this option harder to hedge than a standard option? Why or why not?</p>
</div>
<div id="exr-exotic-greeks" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.10</strong></span> Calculate the Greeks for exotic payoffs:</p>
<ol type="a">
<li>For a derivative paying <span class="math inline">\(S_T^2\)</span>, find the value, delta, and gamma using risk-neutral valuation</li>
<li>For a derivative paying <span class="math inline">\(\log(S_T)\)</span>, repeat the calculation</li>
<li>Verify both satisfy the fundamental PDE: <span class="math inline">\(rV = \frac{\partial V}{\partial t} + (r-q)S\frac{\partial V}{\partial S} + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 V}{\partial S^2}\)</span></li>
<li>Compare the hedging difficulty (gamma exposure) of these payoffs to standard options.</li>
</ol>
</div>
<p>:::{#digital option replication} Modify the code which simulates portfolio insurance to simulate replication of a cash digital option. Where do the largest errors tend to occur? :::</p>
<p>:::{#option replication and transaction costs} Modify the code which simulates portfolio insurance to incur a transaction cost. One model has ask price <span class="math inline">\(1.01 S_t\)</span> and and bid price share <span class="math inline">\(0.99 S_t\)</span>. Another model has ask price <span class="math inline">\(S_t +.005\)</span> and bid price <span class="math inline">\(S_t - .005\)</span>. Try different rebalancing frequencies. What rebalancing frequency gives the best hedging? Where do the largest errors tend to occur? :::</p>
</section>
<section id="discrete-hedging-and-practical-implementation" class="level4">
<h4 class="anchored" data-anchor-id="discrete-hedging-and-practical-implementation">Discrete Hedging and Practical Implementation</h4>
<div id="exr-discrete-hedging-analysis" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.11</strong></span> Extend the discrete hedging simulation from the chapter:</p>
<ol type="a">
<li>Compare hedging errors for different rebalancing frequencies: daily, weekly, monthly</li>
<li>Analyze how hedging errors scale with volatility and time to expiration<br>
</li>
<li>Study the impact of transaction costs: assume 0.1% bid-ask spread on each rebalance</li>
<li>Find the optimal rebalancing frequency that minimizes total cost (hedging error + transaction costs)</li>
</ol>
</div>
<div id="exr-gamma-scalping" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.12</strong></span> Analyze the gamma scalping strategy:</p>
<ol type="a">
<li>Show that a delta-hedged short option position has P&amp;L approximately equal to <span class="math inline">\(-\frac{1}{2}\Gamma(\Delta S)^2\)</span></li>
<li>Simulate this P&amp;L for different realized volatilities vs.&nbsp;implied volatility</li>
<li>Demonstrate that selling options when implied volatility &gt; realized volatility is profitable</li>
<li>Account for the theta decay and show the complete P&amp;L attribution</li>
</ol>
</div>
</section>
<section id="implied-volatility-and-market-practice" class="level4">
<h4 class="anchored" data-anchor-id="implied-volatility-and-market-practice">Implied Volatility and Market Practice</h4>
<div id="exr-implied-vol-calculation" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 9.13</strong></span> Implement an implied volatility calculator:</p>
<ol type="a">
<li>Use numerical methods (bisection or Newton-Raphson) to invert the Black-Scholes formula</li>
<li>Test with market-like option prices and verify convergence</li>
<li>Handle edge cases: very deep ITM/OTM options, very short/long expirations</li>
<li>Compare computational efficiency of different numerical methods</li>
</ol>
</div>
</section>
</section>
<section id="summary" class="level2" data-number="9.9">
<h2 data-number="9.9" class="anchored" data-anchor-id="summary"><span class="header-section-number">9.9</span> Summary</h2>
<p>The Black-Scholes model combines the theoretical foundations of arbitrage pricing with practical implementation:</p>
<ol type="1">
<li><strong>Change of numeraire</strong>: Digital options under different measures give the formula</li>
<li><strong>Replication</strong>: Delta hedging shows how to replicate option payoffs</li>
<li><strong>Fundamental PDE</strong>: All Europena style derivatives satisfy the same partial differential equation with diffrent boundary conditions.</li>
<li><strong>Greeks</strong>: Sensitivities guide risk management and hedging</li>
<li><strong>Market practice</strong>: Implied volatilities reveal market expectations and model limitations</li>
</ol>
<p>The model’s elegance lies in showing that, under its assumptions, options can be perfectly hedged through dynamic trading. While real markets violate these assumptions, the Black-Scholes framework remains the foundation for understanding option pricing and hedging.</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>See Karatzas and Shreve (1991).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The implementation uses Numba JIT compilation for significant performance improvements (typically 20-100x speedup compared to pure Python loops).<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Chapter_ArbitragePricing.html" class="pagination-link" aria-label="Arbitrage Pricing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Arbitrage Pricing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Chapter_MertonMargrabeBlack.html" class="pagination-link" aria-label="Merton, Black, and Margrabe">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Merton, Black, and Margrabe</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><ul><li><a href="https://github.com/math-finance-book/book-published-code.git/blob/main/Chapter_BlackScholes.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></div></div></footer></body></html>